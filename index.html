<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Economy Hub Ultra - Green Master Edition (Cart & Anim)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-dark: #0e0f11;
            --bg-sidebar: #18191c;
            --bg-main: #232428;
            --bg-card: #2f3136;
            --blurple: #5865f2;
            --green: #2ecc71;
            --green-glow: rgba(46, 204, 113, 0.3);
            --text-full: #ffffff;
            --text-muted: #a3a6aa;
            --red: #e74c3c;
            --yellow: #faa61a;
            --border: rgba(255,255,255,0.05);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--bg-dark); color: var(--text-full); overflow: hidden; }

        /* –°–ö–†–û–õ–õ–ë–ê–† */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3e4046; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--green); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-item { animation: fadeIn 0.3s ease-out forwards; }

        .app-container { display: flex; width: 100vw; height: 100vh; }

        /* –°–ê–ô–î–ë–ê–† */
        .sidebar { width: 350px; background: var(--bg-sidebar); border-right: 1px solid #000; display: none; flex-direction: column; }
        body.admin-mode .sidebar { display: flex; }
        .sidebar-header { padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); }
        .warehouse-scroll { flex: 1; overflow-y: scroll; padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #121315; }
        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —É–∑–µ–ª –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ —Å–∫–ª–∞–¥–µ */
/* –£–∑–µ–ª –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ */
.item-node { 
    background: var(--bg-card); 
    border-radius: 8px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    border: 1px solid transparent; 
    transition: 0.2s; 
    padding: 8px 4px;
    height: 80px; /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –Ω–µ "—Å—Ö–ª–æ–ø—ã–≤–∞–ª–æ—Å—å" */
    text-decoration: none;
    overflow: hidden;
}

.item-node:hover { 
    transform: scale(1.05); 
    border-color: var(--green); 
    box-shadow: 0 0 15px var(--green-glow); 
    z-index: 10; 
}

.item-node img { 
    width: 32px; 
    height: 32px; 
    flex-shrink: 0; /* –ó–ê–ü–†–ï–©–ê–ï–¢ –∫–∞—Ä—Ç–∏–Ω–∫–µ —Å–∂–∏–º–∞—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ */
    image-rendering: pixelated; 
    margin-bottom: 6px;
    object-fit: contain;
}

/* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ */
.item-node span {
    font-size: 10px;
    color: var(--text-muted);
    width: 100%;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* –¢—Ä–æ–µ—Ç–æ—á–∏–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∏–º–µ–Ω */
    padding: 0 2px;
    flex-shrink: 0; /* –¢–µ–∫—Å—Ç —Ç–æ–∂–µ –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–∂–∏–º–∞—Ç—å—Å—è */
}

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg-main); }
        .nav { 
            height: 75px; 
            background: var(--bg-sidebar); 
            padding: 0 25px; 
            display: flex; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            position: relative;
        }

        .nav-left { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex: 1; 
            z-index: 2;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∏—Å–∫–∞ */
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∏—Å–∫–∞ */
.nav-center { 
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%); 
    z-index: 10;
    display: flex;
    justify-content: center;
    transition: all 0.4s ease;
}

/* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –ø–æ–∏—Å–∫–∞ (–î–µ—Å–∫—Ç–æ–ø) */
input#search { 
    width: 160px; 
    cursor: pointer; 
    text-align: center;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s, border-color 0.3s;
    background: var(--bg-dark) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat 12px center;
    padding-left: 35px;
}

input#search:focus { 
    width: 450px; 
    text-align: left;
}

/* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø (–§–∏–∫—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏) */
@media (max-width: 1100px) {
    .nav {
        height: auto;
        flex-direction: column;
        padding: 15px;
        gap: 15px;
    }

    .nav-center { 
        position: relative; /* –û—Ç–º–µ–Ω—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
        left: 0; 
        transform: none; 
        width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É –Ω–∞ –º–æ–±–∏–ª–∫–µ */
        order: 2; /* –°—Ç–∞–≤–∏–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
    }

    input#search { 
        width: 100% !important; /* –ù–∞ –º–æ–±–∏–ª–∫–µ –≤—Å–µ–≥–¥–∞ —à–∏—Ä–æ–∫–∏–π */
        max-width: 100%;
        text-align: left;
    }

    .nav-left, .nav-right {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ –∑–∞ —ç–∫—Ä–∞–Ω */
    }
}

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ –∏ —Å–µ–ª–µ–∫—Ç–æ–≤ */
input, select { 
    background: var(--bg-dark); 
    color: #fff; 
    border: 1px solid var(--border); 
    padding: 8px 12px; 
    border-radius: 8px; 
    outline: none; 
    transition: 0.3s; 
    height: 38px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö */
    cursor: pointer;
}

/* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –º–æ–¥—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) */
.nav-left select {
    width: 160px; /* –ï–¥–∏–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –æ–∫–æ–Ω —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
    flex-shrink: 0; /* –ù–µ –¥–∞–µ—Ç –∏–º —Å–∂–∏–º–∞—Ç—å—Å—è –º–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä–∞ */
    font-size: 13px;
}

input:focus, select:focus { 
    border-color: var(--green); 
    box-shadow: 0 0 10px var(--green-glow); 
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 1100px) {
    .nav-left {
        display: grid; /* –ù–∞ –º–æ–±–∏–ª–∫–∞—Ö –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ç–∫–æ–π */
        grid-template-columns: 1fr 1fr; /* –í –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
        gap: 10px;
        width: 100%;
    }

    .nav-left select {
        width: 100%; /* –ù–∞ –º–æ–±–∏–ª–∫–∞—Ö –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∫–æ–ª–æ–Ω–∫—É */
    }
}

        .market-scroll { flex: 1; overflow-y: scroll; padding: 25px; }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        
        /* –ö–ê–†–¢–û–ß–ö–ê */

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ */
.cart-item { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    background: var(--bg-dark); 
    padding: 10px; 
    border-radius: 10px; 
    margin-bottom: 8px; 
    border: 1px solid var(--border);
}

/* –ë–ª–æ–∫ —Å —Ç–µ–∫—Å—Ç–æ–º (–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞) */
.cart-item-info {
    flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ */
    min-width: 0; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç—É –≤–Ω—É—Ç—Ä–∏ —Å–∂–∏–º–∞—Ç—å—Å—è */
}

.cart-item-info b {
    display: block;
    white-space: nowrap; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
    overflow: hidden; /* –°–∫—Ä—ã—Ç—å —Ç–æ, —á—Ç–æ –Ω–µ –≤–ª–µ–∑–ª–æ */
    text-overflow: ellipsis; /* –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–æ–µ—Ç–æ—á–∏–µ */
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º */
.cart-item-controls {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–Ω–æ–ø–∫–∞–º —É–º–µ–Ω—å—à–∞—Ç—å—Å—è –≤ —Ä–∞–∑–º–µ—Ä–µ */
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
.cart-qty-input {
    width: 45px !important;
    min-width: 45px !important;
    padding: 4px !important;
    text-align: center;
    background: var(--bg-main) !important;
    border: 1px solid var(--green) !important;
}


        .card > div[style*="font-weight:700"] {
            display: -webkit-box !important;
            -webkit-line-clamp: 2 !important;
            -webkit-box-orient: vertical !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            word-break: break-word !important;
            line-height: 1.2em !important;
            height: 2.4em !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            margin: 0 !important; 
            padding: 0 !important;
        }

        .card > div[style*="font-size:10px"] { margin-top: -2px !important; }
        .card { 
            background: var(--bg-card); border-radius: 15px; padding: 18px; position: relative; 
            border: 1px solid var(--border); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .card:hover { 
            transform: translateY(-5px) scale(1.03); 
            border-color: var(--green); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px var(--green-glow);
            background: #36393f;
            z-index: 5;
        }
        .card img { width: 50px; height: 50px; display: block; margin: 0 auto 12px; image-rendering: pixelated; transition: 0.3s; }
        .card:hover img { transform: scale(1.2); }
        .price-badge { text-align: center; margin-top: 12px; background: var(--bg-dark); padding: 8px; border-radius: 8px; font-size: 14px; font-weight: bold; color: var(--green); border: 1px solid transparent; transition: 0.3s; }
        .card:hover .price-badge { border-color: var(--green); box-shadow: 0 0 10px var(--green-glow); color: #fff; background: rgba(46, 204, 113, 0.2); }

        #cart-trigger {
            position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--green);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 10px 30px var(--green-glow); z-index: 999; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; visibility: hidden; transform: translateY(100px) scale(0.5);
        }

        #cart-trigger.visible { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
        #cart-trigger:hover { transform: scale(1.1); background: #27ae60; }

        .cart-item { 
            display: flex; align-items: center; gap: 12px; background: var(--bg-dark); 
            padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border);
        }
        .cart-item img { width: 40px !important; height: 40px !important; object-fit: contain; image-rendering: pixelated; }

        button { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--green); color: #000; transition: 0.2s; }
        button:hover { filter: brightness(1.1); transform: scale(1.02); }
        button.danger { background: var(--red); color: #fff; }
        button.yellow { background: var(--yellow); color: #000; }
        button.blurple { background: var(--blurple); color: #fff; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(6px); display: none; align-items: center; justify-content: center; z-index: 10001; }
        .modal-box { background: var(--bg-sidebar); padding: 30px; border-radius: 20px; width: 420px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }

        .admin-view { display: none !important; }
        body.admin-mode .admin-view { display: flex !important; }

        @keyframes pulse-green {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
    50% { transform: scale(1.1); box-shadow: 0 0 15px 5px rgba(46, 204, 113, 0.4); border-color: var(--green); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
}

.added-flash {
    animation: pulse-green 0.4s ease-out;
    z-index: 100;
}

    </style>
</head>
<body class="player-mode">

<div id="edit-modal" class="modal">
    <div class="modal-box">
        <h2 style="margin:0 0 10px 0; color:var(--green)">–†–µ–¥–∞–∫—Ç–æ—Ä</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label style="font-size:10px">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="ed-name"></div>
            <div><label style="font-size:10px">–¶–µ–Ω–∞</label><input type="number" id="ed-price"></div>
        </div>
        <div><label style="font-size:10px">–ò–∫–æ–Ω–∫–∞</label><input type="text" id="ed-img"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label style="font-size:10px">–ú–æ–¥</label><select id="ed-mod"></select></div>
            <div><label style="font-size:10px">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="ed-cat"></select></div>
        </div>
        <button onclick="confirmEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="closeModals()" style="background:transparent; color:var(--text-muted)">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="cart-modal" class="modal">
    <div class="modal-box">
        <h2 style="color: var(--green); margin: 0 0 15px 0;">üõí –ó–ê–ö–ê–ó</h2>
        <div id="cart-items-list" style="max-height: 400px; overflow-y: auto;"></div>
        <div style="border-top: 2px solid var(--border); padding-top: 15px;">
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-bottom: 15px;">
                <span>–ò–¢–û–ì–û:</span><span id="cart-total" style="color: var(--green);">0 $</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="danger" onclick="clearCart()" style="flex: 1;">–û–ß–ò–°–¢–ò–¢–¨</button>
                <button onclick="closeModals()" style="flex: 1; background: #4f545c; color: white;">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; gap: 5px;">
                <label style="flex: 1; background: #36393f; color: white; padding: 10px; border-radius: 8px; text-align:center; cursor:pointer; font-size:13px;">
                    JAR <span id="loadedCount"></span>
                    <input type="file" id="jarLoader" accept=".jar" hidden multiple>
                </label>
                <button onclick="createCustomItem()" class="blurple">+</button>
            </div>
        </div>
        <div id="warehouse" class="warehouse-scroll"></div>
    </div>

    <div class="main">
        <div class="nav">
            <div class="nav-left">
                <span id="curSrvTitle" style="font-weight: bold; color: var(--green);">Mystic 1.20.1</span>
                <select id="filterMod" onchange="render()"><option value="all">–í—Å–µ –º–æ–¥—ã</option></select>
                <select id="filterCat" onchange="render()"><option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
                <select id="sortPrice" onchange="render()">
                    <option value="none">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="low">–î–µ—à–µ–≤–ª–µ</option>
                    <option value="high">–î–æ—Ä–æ–∂–µ</option>
                </select>
            </div>
            <div class="nav-center"><input type="text" id="search" placeholder="–ü–æ–∏—Å–∫..." oninput="render()"></div>
            <div class="nav-right">
    <button onclick="toggleAdmin()" id="admBtn" style="display: none;">–ê–î–ú–ò–ù</button>
    
    <div class="admin-view" style="gap:5px;">
        <div style="display:flex; gap:2px;">
            <button onclick="manualAdd('mod')" title="–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥">+</button>
            <button onclick="manualDelete('mod')" class="danger" title="–£–¥–∞–ª–∏—Ç—å –º–æ–¥">‚àí</button>
        </div>
        <div style="display:flex; gap:2px;">
            <button onclick="manualAdd('cat')" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">+</button>
            <button onclick="manualDelete('cat')" class="danger" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">‚àí</button>
        </div>
        <button onclick="saveGlobal()" class="blurple">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
    </div>
</div>
        </div>
        <div class="market-scroll"><div id="grid" class="market-grid"></div></div>
    </div>
</div>

<div id="cart-trigger" onclick="openCart()"><span>üõí</span><div id="cart-count">0</div></div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>



 // 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–û–°–¢–ê–í–¨ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó)
const firebaseConfig = {
    apiKey: "AIzaSyBJheg1xrRBz6wHXzpV4dxGDFtgPm3gjJQ",
    authDomain: "ecomyst-d5c0e.firebaseapp.com",
    databaseURL: "https://ecomyst-d5c0e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ecomyst-d5c0e",
    storageBucket: "ecomyst-d5c0e.firebasestorage.app",
    messagingSenderId: "745331166808",
    appId: "1:745331166808:web:1e004fd05c0d9a0301442d",
    measurementId: "G-GRE63HQSZY"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let db = { servers: [{name: "–ó–∞–≥—Ä—É–∑–∫–∞...", items: []}], mods: [], cats: [] };
let cart = [];
let curSrvIdx = 0;
let isAdmin = false;
let adminToken = ""; 
let editingIdx = null;

// 3. –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å–ª—É—à–∞–µ—Ç –∫–ª–∞–≤–∏—à—É L)
function init() {
    console.log("Economy Hub Initialized.");
    
    // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
    database.ref('shopData').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            db = data;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫
            if(!db.servers) db.servers = [{name: "Mystic 1.20.1", items: []}];
            if(!db.mods) db.mods = [];
            if(!db.cats) db.cats = [];
            
            updateSelects(); 
            render();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (["INPUT", "TEXTAREA", "SELECT"].includes(document.activeElement.tagName)) return;
        if (e.key.toLowerCase() === 'l' || e.key.toLowerCase() === '–¥') { 
            toggleAdmin(); 
        }
    });
}

// 4. –õ–æ–≥–∏–∫–∞ –∞–¥–º–∏–Ω–∞
async function toggleAdmin() {
    if (!isAdmin) {
        const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: if (pass !== '—Ç–≤–æ–π_–ø–∞—Ä–æ–ª—å') return alert('–°—Ç–æ–ø!');
        if (!pass) return;

        adminToken = pass; 
        isAdmin = true;
        
        document.body.classList.add('admin-mode');
        document.getElementById('admBtn').style.display = 'block';
        
        alert("–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
        render();
    } else {
        isAdmin = false;
        adminToken = "";
        document.body.classList.remove('admin-mode');
        document.getElementById('admBtn').style.display = 'none';
        render();
    }
}

// ... (–¥–∞–ª–µ–µ –∏–¥—É—Ç —Ç–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ render, saveGlobal –∏ —Ç.–¥.)

// –í –°–ê–ú–û–ú –ö–û–ù–¶–ï –°–ö–†–ò–ü–¢–ê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–´–ó–û–í–ò:
init();
// 5. –°–û–•–†–ê–ù–ï–ù–ò–ï –í GOOGLE (–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ fetch)
// –í –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–æ–±–∞–≤–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–≤–µ—Ä–∫–∏
let adminToken = ""; 

async function saveGlobal() {
    if (!isAdmin) return alert("–í—ã –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∞!");

    // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –≤–µ—Ç–∫—É shopData
    // –ú—ã –ø–µ—Ä–µ–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ü–µ–ª–∏–∫–æ–º. Firebase –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.
    database.ref('shopData').set(db)
        .then(() => alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –æ–±–ª–∞–∫–æ–º!"))
        .catch(err => {
            console.error(err);
            alert("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ (Rules) –≤ Firebase –∏–ª–∏ –ø–∞—Ä–æ–ª—å.");
        });
}

// ... –û–°–¢–ê–õ–¨–ù–´–ï –¢–í–û–ò –§–£–ù–ö–¶–ò–ò (render, addToCart, openEdit –∏ —Ç.–¥.) –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ...

// 4. –û–¢–†–ò–°–û–í–ö–ê –ü–†–ï–î–ú–ï–¢–û–í
// 4. –û–¢–†–ò–°–û–í–ö–ê –ü–†–ï–î–ú–ï–¢–û–í
function render() {
    if (!db || !db.servers || !db.servers[curSrvIdx]) return; 

    const grid = document.getElementById('grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    const search = document.getElementById('search').value.toLowerCase();
    const selMod = document.getElementById('filterMod').value;
    const selCat = document.getElementById('filterCat').value;
    const sort = document.getElementById('sortPrice').value;
    
    // 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    let filtered = db.servers[curSrvIdx].items.filter(it => {
        const matchesSearch = it.name.toLowerCase().includes(search);
        const matchesMod = (selMod === 'all' || it.mod === selMod);
        const matchesCat = (selCat === 'all' || it.cat === selCat);
        return matchesSearch && matchesMod && matchesCat;
    });

    // 2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    if(sort === 'low') filtered.sort((a,b) => a.price - b.price);
    if(sort === 'high') filtered.sort((a,b) => b.price - a.price);

    // 3. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
    filtered.forEach((it) => {
        const realIdx = db.servers[curSrvIdx].items.indexOf(it);
        const card = document.createElement('div');
        card.className = 'card animate-item';
        
        card.innerHTML = `
            <div class="admin-view" style="position:absolute; top:10px; right:10px; gap:4px; z-index:10;">
                <button class="yellow" style="padding:4px 6px" onclick="event.stopPropagation(); openEdit(${realIdx})">‚úèÔ∏è</button>
                <button class="danger" style="padding:4px 6px" onclick="event.stopPropagation(); del(${realIdx})">√ó</button>
            </div>
            
            <img src="${it.img}" onerror="this.src='https://i.imgur.com/hYfN4D7.png'">
            
            <div style="text-align:center; font-weight:700; font-size:16px; margin-bottom: 4px;">${it.name}</div>
            
            <div style="text-align:center; font-size:11px; color:var(--text-muted); margin-bottom: 12px;">
                ${it.mod || 'Vanilla'} ‚Ä¢ ${it.cat || '–ü—Ä–µ–¥–º–µ—Ç—ã'}
            </div>

            <div class="price-badge">${it.price} $</div>
        `;
        
        card.onclick = isAdmin ? () => openEdit(realIdx) : (e) => addToCart(it, e);
        grid.appendChild(card);
    });
}

// 5. –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´
function addToCart(item, event) {
    if(isAdmin) return;
    let existing = cart.find(c => c.name === item.name && c.img === item.img);
    if(existing) existing.count++; else cart.push({...item, count: 1});
    updateCartUI();
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª–µ—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
    if (event) {
        const btn = document.getElementById('cart-trigger');
        const rect = btn.getBoundingClientRect();
        const flyer = document.createElement('img');
        flyer.src = item.img; 
        flyer.style.cssText = `width:50px;height:50px;position:fixed;z-index:10000;transition:all 0.8s ease;left:${event.clientX-25}px;top:${event.clientY-25}px;`;
        document.body.appendChild(flyer);
        setTimeout(() => { 
            flyer.style.left = rect.left + 20 + 'px'; 
            flyer.style.top = rect.top + 20 + 'px'; 
            flyer.style.width = '15px'; flyer.style.height = '15px'; flyer.style.opacity = '0.5'; 
        }, 10);
        setTimeout(() => { flyer.remove(); }, 800);
    }
}

function updateCartUI() {
    const count = cart.reduce((s, i) => s + i.count, 0);
    const trigger = document.getElementById('cart-trigger');
    document.getElementById('cart-count').innerText = count;
    if (count > 0 && !isAdmin) trigger.classList.add('visible'); else trigger.classList.remove('visible');
}

function openCart() {
    const list = document.getElementById('cart-items-list');
    list.innerHTML = '';
    let total = 0;
    cart.forEach((it, idx) => {
        total += it.price * it.count;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
            <img src="${it.img}" style="width:40px; height:40px; image-rendering:pixelated;">
            <div class="cart-item-info">
                <b title="${it.name}">${it.name}</b>
                <div style="font-size:11px; color:var(--green)">${it.price} $ / —à—Ç.</div>
            </div>
            <div class="cart-item-controls">
                <button onclick="changeQty(${idx}, -1)">-</button>
                <input type="number" class="cart-qty-input" value="${it.count}" onchange="updateQtyManual(${idx}, this.value)">
                <button onclick="changeQty(${idx}, 1)">+</button>
                <button class="danger" onclick="deleteFromCart(${idx})">√ó</button>
            </div>`;
        list.appendChild(div);
    });
    document.getElementById('cart-total').innerText = total + ' $';
    document.getElementById('cart-modal').style.display = 'flex';
}

function changeQty(index, delta) {
    cart[index].count += delta;
    if (cart[index].count <= 0) cart.splice(index, 1);
    finishCartUpdate();
}

function updateQtyManual(index, value) {
    let val = parseInt(value);
    if (isNaN(val) || val <= 0) cart.splice(index, 1); else cart[index].count = val;
    finishCartUpdate();
}

function deleteFromCart(index) {
    cart.splice(index, 1);
    finishCartUpdate();
}

function finishCartUpdate() {
    updateCartUI();
    if (cart.length > 0) openCart(); else closeModals();
}

function clearCart() { cart = []; updateCartUI(); closeModals(); }

// 6. –§–£–ù–ö–¶–ò–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
function updateSelects() {
    const fm = document.getElementById('filterMod'), fc = document.getElementById('filterCat');
    const em = document.getElementById('ed-mod'), ec = document.getElementById('ed-cat');
    fm.innerHTML = '<option value="all">–í—Å–µ –º–æ–¥—ã</option>' + db.mods.map(m => `<option value="${m}">${m}</option>`).join('');
    fc.innerHTML = '<option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' + db.cats.map(c => `<option value="${c}">${c}</option>`).join('');
    em.innerHTML = db.mods.map(m => `<option value="${m}">${m}</option>`).join('');
    ec.innerHTML = db.cats.map(c => `<option value="${c}">${c}</option>`).join('');
}



function openEdit(i) {
    editingIdx = i; const it = db.servers[curSrvIdx].items[i];
    document.getElementById('ed-name').value = it.name;
    document.getElementById('ed-price').value = it.price;
    document.getElementById('ed-img').value = it.img;
    document.getElementById('ed-mod').value = it.mod;
    document.getElementById('ed-cat').value = it.cat;
    document.getElementById('edit-modal').style.display = 'flex';
}

function confirmEdit() {
    const it = db.servers[curSrvIdx].items[editingIdx];
    it.name = document.getElementById('ed-name').value;
    it.price = parseFloat(document.getElementById('ed-price').value) || 0;
    it.img = document.getElementById('ed-img').value;
    it.mod = document.getElementById('ed-mod').value;
    it.cat = document.getElementById('ed-cat').value;
    closeModals(); render();
}

function del(i) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { db.servers[curSrvIdx].items.splice(i,1); render(); } }

function manualAdd(type) { 
    const v = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:"); 
    if(v) { 
        if(type === 'mod') db.mods.push(v); else db.cats.push(v); 
        updateSelects(); 
    } 
}

function manualDelete(type) {
    const list = type === 'mod' ? db.mods : db.cats;
    const choice = prompt(`–£–¥–∞–ª–∏—Ç—å ${type}:\n${list.join(', ')}`);
    const index = list.indexOf(choice);
    if (index > -1) { list.splice(index, 1); updateSelects(); render(); }
}

function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

function createCustomItem() {
    db.servers[curSrvIdx].items.push({ 
        name: "–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç", 
        img: "https://i.imgur.com/hYfN4D7.png", 
        mod: db.mods[0], cat: db.cats[0], price: 0 
    });
    render(); 
    openEdit(db.servers[curSrvIdx].items.length - 1);
}

// 7. –ó–ê–ì–†–£–ó–ö–ê JAR
// 7. –ó–ê–ì–†–£–ó–ö–ê JAR
document.getElementById('jarLoader').onchange = async (e) => {
    const files = e.target.files; 
    if(!files.length) return;
    
    const w = document.getElementById('warehouse'); 
    w.innerHTML = ''; 
    let total = 0;

    for (let file of files) {
        const zip = await JSZip.loadAsync(file);
        const mName = file.name.replace('.jar', '');
        
        if(!db.mods.includes(mName)) { 
            db.mods.push(mName); 
            updateSelects(); 
        }

        const tex = Object.keys(zip.files).filter(p => p.endsWith('.png') && p.includes('textures/'));
        
        for(let p of tex) {
            const b64 = await zip.file(p).async("base64");
            const img = `data:image/png;base64,${b64}`;
            const itemName = p.split('/').pop().replace('.png', '');
            
            const div = document.createElement('div');
            div.className = 'item-node';
            div.innerHTML = `<img src="${img}"><span title="${itemName}">${itemName}</span>`;
            
            // –í–û–¢ –¢–£–¢ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ö–õ–ò–ö
            div.onclick = function() {
                // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–¥–º–∏–≥–∏–≤–∞–Ω–∏—è
                this.classList.remove('added-flash');
                void this.offsetWidth; 
                this.classList.add('added-flash');

                // –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const selMod = document.getElementById('filterMod').value;
                const selCat = document.getElementById('filterCat').value;

                db.servers[curSrvIdx].items.push({ 
                    name: itemName, 
                    img: img, 
                    mod: (selMod === 'all' ? mName : selMod), 
                    cat: (selCat === 'all' ? "–ë–ª–æ–∫–∏" : selCat), 
                    price: parseFloat(document.getElementById('default-price')?.value || 0)
                });

                render();
            };
            w.appendChild(div); 
            total++;
        }
    }
    document.getElementById('loadedCount').innerText = `(${total})`;
};



</script>
</body>
</html>


